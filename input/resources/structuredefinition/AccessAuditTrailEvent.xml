<StructureDefinition xmlns="http://hl7.org/fhir">
   <id value="AccessAuditTrailEvent"></id>
   <text>
      <status value="additional"></status>
      <div xmlns="http://www.w3.org/1999/xhtml">StructureDefinition for the AccessAuditTrailEvent.</div>
   </text>
   <url value="http://fhir.ch/ig/ch-atc/StructureDefinition/AccessAuditTrailEvent"></url>
   <name value="AccessAuditTrailEvent"></name>
   <title value="AccessAuditTrailEvent"></title>
   <status value="active"></status>
   <experimental value="false"></experimental>
   <date value="2018-05-28"></date>
   <publisher value="eHealth Suisse"/>
   <contact>
      <name value="eHealth Suisse"/>
      <telecom>
         <system value="url"/>
         <value value="https://www.e-health-suisse.ch/"/>
      </telecom>
   </contact>
   <contact>
      <name value="Oliver Egger"/>
      <telecom>
         <system value="email"/>
         <value value="oliver.egger@ahdis.ch"/>
      </telecom>
   </contact>
   <description value="This profile defines the content of the access audit trail event which a community has to provide for a patients audit trail."></description>
   <jurisdiction>
      <coding>
         <system value="urn:iso:std:iso:3166"></system>
         <code value="CH"></code>
      </coding>
   </jurisdiction>
   <copyright value="CC-BY-SA-4.0"></copyright>
   <fhirVersion value="4.0.1"></fhirVersion>
   <mapping>
      <identity value="ch-atc"></identity>
      <uri value="https://www.bag.admin.ch/bag/en/home.html"></uri>
      <name value="Mapping to CH ATC"></name>
   </mapping>
   <kind value="resource"></kind>
   <abstract value="false"></abstract>
   <type value="AuditEvent"></type>
   <baseDefinition value="http://hl7.org/fhir/StructureDefinition/AuditEvent"></baseDefinition>
   <derivation value="constraint"></derivation>
   <differential>
      <element id="AuditEvent">
         <path value="AuditEvent"></path>
         <short value="Access Audit Trail Event Content Profile"></short>
         <constraint>
            <key value="ch-atc-aae-1"></key>
            <severity value="error"></severity>
            <human value="subtype needs to be fixed to ATC_LOG_READ"></human>
            <expression value="subtype.exists() and subtype.count()=1 and subtype[0].code='ATC_LOG_READ'"></expression>
         </constraint>
      </element>
      
      <element id="AuditEvent.type">
         <path value="AuditEvent.type"></path>
         <binding>
            <extension url="http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName">
               <valueString value="AuditEventType"></valueString>
            </extension>
            <strength value="extensible"></strength>
            <description value="Type of event."></description>
            <valueSet value="http://hl7.org/fhir/ValueSet/audit-event-type"></valueSet>
         </binding>
      </element>

      <element id="AuditEvent.subtype">
         <path value="AuditEvent.subtype"></path>
         <min value="1"></min>
         <max value="1"></max>
         <binding>
            <extension url="http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName">
               <valueString value="ConditionKind"></valueString>
            </extension>
            <strength value="required"></strength>
            <description value="Audit Trail Event Type"></description>
            <valueSet value="http://fhir.ch/ig/ch-atc/ValueSet/AccessAuditTrailEventType"></valueSet>
         </binding>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="Event Type"></map>
         </mapping>
      </element>

      <element id="AuditEvent.recorded">
         <path value="AuditEvent.recorded"></path>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="Event Date and Time"></map>
         </mapping>
      </element>

      <element id="AuditEvent.agent">
         <path value="AuditEvent.agent"></path>
         <short value="Patient, repeated if representative"></short>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="Participants"></map>
         </mapping>
      </element>
      <element id="AuditEvent.agent.role">
         <path value="AuditEvent.agent.role"></path>
         <min value="1"></min>
         <max value="1"></max>
         <binding>
            <extension url="http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName">
               <valueString value="ConditionKind"></valueString>
            </extension>
            <strength value="required"></strength>
            <description value="EPR Participant"></description>
            <valueSet value="http://fhir.ch/ig/ch-atc/ValueSet/EprParticipant"></valueSet>
         </binding>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="role (PAT, REP)"></map>
         </mapping>
      </element>
      <element id="AuditEvent.agent.who">
         <path value="AuditEvent.agent.who"/>
         <type>
            <code value="Reference"/>
            <targetProfile value="http://hl7.org/fhir/StructureDefinition/PractitionerRole"/>
            <targetProfile value="http://hl7.org/fhir/StructureDefinition/Practitioner"/>
            <targetProfile value="http://hl7.org/fhir/StructureDefinition/Organization"/>
            <targetProfile value="http://hl7.org/fhir/StructureDefinition/Device"/>
            <targetProfile value="http://hl7.org/fhir/StructureDefinition/Patient"/>
            <targetProfile value="http://hl7.org/fhir/StructureDefinition/RelatedPerson"/>
         </type>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="applicable identifier"></map>
         </mapping>
      </element>
      <element id="AuditEvent.agent.name">
         <path value="AuditEvent.agent.name"></path>
         <definition value="AttributeStatement/Attribute[@Name='urn:oasis:names:tc:xspa:1.0:subject:subject- id']/AttributeValue"></definition>
         <min value="1"></min>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="Name"></map>
         </mapping>
      </element>
      <element id="AuditEvent.agent.requestor">
         <path value="AuditEvent.agent.requestor"></path>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="if participant is Initiator"></map>
         </mapping>
      </element>

      <element id="AuditEvent.entity">
         <path value="AuditEvent.entity"></path>
         <slicing>
            <discriminator>
               <type value="value"></type>
               <path value="type.code"></path>
            </discriminator>
            <discriminator>
               <type value="value"></type>
               <path value="role.code"></path>
            </discriminator>
            <rules value="open"></rules>
         </slicing>
      </element>

      <!-- Slice Patient -->
      <element id="AuditEvent.entity:Patient">
         <path value="AuditEvent.entity"></path>
         <sliceName value="Patient"></sliceName>
         <short value="Patient"></short>
         <min value="1"></min>
         <max value="1"></max>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="Patient"></map>
         </mapping>
      </element>
      <element id="AuditEvent.entity:Patient.what.identifier">
         <path value="AuditEvent.entity.what.identifier"></path>
         <short value="Patient Id (EPR-SPID)"></short>
         <min value="1"></min>
         <max value="1"></max>
         <type>
            <code value="Identifier"></code>
         </type>
         <mapping>
            <identity value="ch-atc"></identity>
            <map value="EPR-SPID"></map>
         </mapping>
      </element>
      <element id="AuditEvent.entity:Patient.what.identifier.system">
         <path value="AuditEvent.entity.what.identifier.system"></path>
         <min value="1"></min>
         <fixedUri value="urn:oid:2.16.756.5.30.1.127.3.10.3"></fixedUri>
      </element>
      <element id="AuditEvent.entity:Patient.type">
         <path value="AuditEvent.entity.type"></path>
         <min value="1"></min>
      </element>
      <element id="AuditEvent.entity:Patient.type.code">
         <path value="AuditEvent.entity.type.code"></path>
         <min value="1"></min>
         <fixedCode value="1"></fixedCode>
      </element>
      <element id="AuditEvent.entity:Patient.role">
         <path value="AuditEvent.entity.role"></path>
         <min value="1"></min>
      </element>
      <element id="AuditEvent.entity:Patient.role.code">
         <path value="AuditEvent.entity.role.code"></path>
         <min value="1"></min>
         <fixedCode value="1"></fixedCode>
      </element>
   </differential>
</StructureDefinition>